# Copilot Instructions (Sophont / Traveller 5)

## Project Intent

This repo is a **rapidly-iterable sandbox** for designing Python classes and supporting tables used to model a *Sophont* (character) according to **Traveller 5 (T5)** concepts.

Current milestone: a **very basic MVP** where `sophont.character.Sophont` owns three state domains — **Aptitudes**, **Epigenetics**, and **Personals** — including the core logic/data structures to apply and collate them.

### Architectural Philosophy

The codebase follows an **Object-Oriented (OO) design as a deliberate stepping stone** toward an Entity-Component-System (ECS) architecture:

- **OO for experimentation**: Class-based design prioritises clarity and rapid iteration while the domain model evolves.
- **ECS-ready patterns now**:
  - Flyweight/interned immutable data → future *Components*
  - Mutable character state in time-ordered collections → future *Entities*
  - Collation/update logic isolated in dedicated methods → future *Systems*
- **Branching strategy**:
  - **Python (master)**: Will mature into a fully data-oriented ECS branch for native hardware leverage.
  - **TypeScript (port)**: Browser-targeted branch derived at a stable milestone; some subsystems will remain OO where ECS offers no benefit in JS runtime.

Python remains the **canonical reference implementation**.

Primary goals:
- Keep the domain model **easy to refactor** as rules interpretation evolves.
- Prefer **clear data types** and predictable behavior over “magic”.
- Separate **immutable rules-data** (skills, characteristics, genes/phenes) from **mutable character state** (acquired packages, training progress).
- Preserve a foundation for **memory-efficient “buff”/“debuff” style** changes via authored packages (and, where relevant, packages generated by logic such as inheritance).

Non-goals (unless explicitly requested):
- Full character generator UI
- Complete T5 rules implementation
- Persistence, database, or networking

## Architecture Snapshot

Top-level domains:
- `sophont/` — character-facing domain objects
  - `sophont.character.Sophont` is the main entry point
  - Three state domains:
    - `sophont.aptitudes.Aptitudes` — skills/knowledge, training progress, computed levels
    - `sophont.epigenetics.Epigenetics` — genotype + acquired gene/phene packages, collated into computed characteristics
    - `sophont.personals.Personals` — granular modifiers (personal day, burden, location, injury tracking) — still evolving

- `game/` — immutable rules-data + packages + mapping tables
  - Flyweight immutable items: `Skill`, `Knowledge`, `Characteristic`, `Gene`, `Phene`, `Species`, `Genotype`
  - Package containers applied over time: `AptitudePackage`, `CharacteristicPackage`, `Event`
  - Lookup tables/helpers live under `game/mappings/`
  - GUID system in `game/uid/`

- `t5/` — isolated module for humanisation helpers related to T5 data types and logic

- `gui/` — NiceGUI interface for demonstrating concepts (not intended as final framework)

Terminology note:
- **Phene** is an uncommon term. In this repository it is used as an “atom” of phenotype: a smallest, composable unit of expressed trait that can be applied/collated (often alongside `Gene`) to compute effective characteristics.

## Coding Conventions

When modifying or adding code:
- Preserve the “**flyweight immutable item**” pattern where it already exists.
  - Use `__slots__` consistently.
  - Initialize immutable fields in `__new__` and keep `__init__` as `pass` where the pattern is used.
  - Prefer deterministic caching keys (tuples of primitive or flyweight items).

- Keep mutable state in dedicated containers:
  - Time-ordered acquired collections (e.g., `SortedKeyList`) are preferred for incremental updates.
  - Collation/summarization should be recomputed only when flagged dirty.

- Avoid introducing new dependencies unless they materially reduce complexity.

- Prefer type hints and small helper functions when they improve clarity.

## Style / Formatting

- Python: 4-space indentation.
- Keep modules focused; avoid circular imports (use local imports where necessary).
- Use docstrings when adding new public classes/functions.

### Ruff / Black (important)

This repo uses **Ruff** for linting (including isort-like import sorting) and **Black** for formatting.
When making changes, keep code aligned with the existing `pyproject.toml` settings.

Key points:
- Expect Ruff to flag **import sorting/formatting** issues (notably `I001`).
- Avoid `from ... import *` in new/edited modules; prefer explicit imports.
- Keep imports grouped and ordered: **stdlib**, **third-party**, **first-party** (`game`, `sophont`, `gui`, `t5`).
- Within a `from x import (...)` block, keep imported names sorted.

Agentic workflow expectation (to reduce iterations):
- After editing Python files, run Ruff’s auto-fix on the touched files.
- Then run Black on the same files.
- Re-check Ruff to confirm zero remaining issues.

## Safety Rails

- Do not “invent” new rules values or tables. If a mapping/table needs extending, place it under `game/mappings/` and keep changes minimal.
- Don’t refactor broadly unless the prompt explicitly asks for it.

## Quick Commands (typical)

- Install runtime deps: `pip install -r requirements.txt`
- Optional dev tools (if present): `pip install -r requirements-dev.txt`

Formatting/linting (recommended after edits):
- Auto-fix lint + imports: `python -m ruff check --fix <paths>`
- Format: `python -m black <paths>`
- Verify lint clean: `python -m ruff check <paths>`
